# åˆ†å±¤æ­¸å› ç­–ç•¥è¨­è¨ˆ

## æ ¸å¿ƒç†å¿µ

**ã€Œä¸€ç­†ç‡Ÿæ”¶å¯ä»¥åŒæ™‚æ­¸å› çµ¦å¤šå€‹æ´»å‹•ï¼Œä½†éœ€è¦æ˜ç¢ºå€åˆ†ä¸åŒå±¤ç´šçš„æ­¸å› é—œä¿‚ã€**

## åˆ†å±¤æ­¸å› æ¶æ§‹

### **ç¬¬ä¸€å±¤ï¼šæ´»å‹•é¡å‹åˆ†å±¤**

ä¸åŒé¡å‹çš„æ´»å‹•å¯ä»¥åŒæ™‚é€²è¡Œï¼Œäº’ä¸è¡çªï¼š

```
ğŸ“± å…¨ç«™æ´»å‹•å±¤ (Site-wide)
â”œâ”€â”€ å­£ç¯€æ€§æ´»å‹•ï¼šæ–°å¹´å¤§ä¿ƒéŠ·ã€å¤æ—¥ç‹‚æ­¡ç¯€
â”œâ”€â”€ å‡æœŸæ´»å‹•ï¼šæ¯è¦ªç¯€æº«é¦¨ç»ç¦®ã€ç«¯åˆä½³ç¯€æ…¶å…¸
â””â”€â”€ å“ç‰Œæ´»å‹•ï¼šå“ç‰Œé€±å¹´æ…¶ã€é™æ™‚é–ƒè³¼48å°æ™‚

ğŸ¯ ç›®æ¨™å°å‘å±¤ (Target-oriented)  
â”œâ”€â”€ æœƒå“¡æ´»å‹•ï¼šæœƒå“¡å°ˆå±¬VIPæ—¥ã€æ–°æœƒå“¡æ‹›å‹Ÿå­£
â”œâ”€â”€ äººç¾¤æ´»å‹•ï¼šå­¸ç”Ÿå°ˆå±¬å„ªæƒ æœˆ
â””â”€â”€ ç”¢å“æ´»å‹•ï¼šæ˜¥å­£æ–°å“ä¸Šå¸‚

ğŸ›ï¸ å“é¡å°ˆå±¬å±¤ (Category-specific)
â”œâ”€â”€ å¤å­£æœé£¾ç‰¹æƒ é€±
â”œâ”€â”€ å±…å®¶ç”Ÿæ´»ç¯€  
â””â”€â”€ æˆ¶å¤–ç”¨å“ä¿ƒéŠ·
```

### **ç¬¬äºŒå±¤ï¼šå½±éŸ¿å¼·åº¦åˆ†å±¤**

```
ğŸ”´ ç›´æ¥å½±éŸ¿ (Direct Attribution)
- ç”¨æˆ¶é€éæ´»å‹•é é¢/å»£å‘Šç›´æ¥é€²å…¥è³¼è²·
- ä½¿ç”¨æ´»å‹•å°ˆå±¬å„ªæƒ ç¢¼
- åœ¨æ´»å‹•å•†å“é é¢ä¸‹å–®

ğŸŸ¡ é–“æ¥å½±éŸ¿ (Indirect Attribution)  
- æ´»å‹•æœŸé–“çš„è‡ªç„¶æµé‡è³¼è²·
- å—æ´»å‹•æ°›åœå½±éŸ¿çš„éæ´»å‹•å•†å“è³¼è²·
- æ´»å‹•å¸¶ä¾†çš„å“ç‰ŒèªçŸ¥æå‡æ•ˆæœ

ğŸŸ¢ ç’°å¢ƒå½±éŸ¿ (Environmental Attribution)
- å‡æœŸæœŸé–“çš„è‡ªç„¶è³¼è²·å¢é•·
- å­£ç¯€æ€§éœ€æ±‚é©…å‹•çš„è³¼è²·
- å¸‚å ´æ•´é«”è¶¨å‹¢å½±éŸ¿
```

### **ç¬¬ä¸‰å±¤ï¼šæ™‚é–“è¦–çª—åˆ†å±¤**

```
âš¡ å³æ™‚æ­¸å›  (0-1å¤©)
- æ´»å‹•ç•¶æ—¥çš„ç›´æ¥è½‰æ›

ğŸ“ˆ çŸ­æœŸæ­¸å›  (1-7å¤©)  
- æ´»å‹•å¼•ç™¼çš„å»¶é²è³¼è²·
- æ¯”è¼ƒè³¼ç‰©å¾Œçš„æ±ºç­–

ğŸ“Š é•·æœŸæ­¸å›  (7-30å¤©)
- æ´»å‹•å°å“ç‰Œå¿ èª åº¦çš„å½±éŸ¿
- å¾©è³¼è¡Œç‚ºçš„æ”¹è®Š
```

## å…·é«”å¯¦ä½œç­–ç•¥

### **ç­–ç•¥ä¸€ï¼šå¤šç¶­åº¦æ­¸å› è¡¨è¨­è¨ˆ**

```sql
-- å»ºç«‹æ´»å‹•æ­¸å› äº‹å¯¦è¡¨
CREATE TABLE campaign_attribution_facts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID REFERENCES orders(id),
    order_date DATE,
    order_amount NUMERIC(10,2),
    
    -- ä¸»è¦æ­¸å› æ´»å‹•
    primary_campaign_id UUID REFERENCES campaigns(id),
    primary_attribution_weight NUMERIC(3,2) DEFAULT 1.0,
    
    -- æ¬¡è¦æ­¸å› æ´»å‹•ï¼ˆJSONé™£åˆ—ï¼‰
    secondary_campaigns JSONB,
    
    -- æ­¸å› å±¤ç´šè³‡è¨Š
    attribution_layer TEXT, -- 'site-wide', 'target-oriented', 'category-specific'
    attribution_strength TEXT, -- 'direct', 'indirect', 'environmental'
    attribution_confidence NUMERIC(3,2), -- 0.0-1.0 ä¿¡å¿ƒåº¦åˆ†æ•¸
    
    -- æ™‚é–“è¦–çª—
    time_window TEXT, -- 'immediate', 'short-term', 'long-term'
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### **ç­–ç•¥äºŒï¼šæ™ºæ…§æ­¸å› æ¼”ç®—æ³•**

```sql
-- æ­¸å› æ¬Šé‡è¨ˆç®—å‡½æ•¸
CREATE OR REPLACE FUNCTION calculate_attribution_weights(
    order_date DATE,
    order_amount NUMERIC,
    user_id UUID
) RETURNS JSONB AS $$
DECLARE
    active_campaigns JSONB := '[]';
    campaign_record RECORD;
    total_weight NUMERIC := 0;
    result JSONB;
BEGIN
    -- æ‰¾å‡ºè©²æ—¥æœŸæ‰€æœ‰æ´»èºçš„æ´»å‹•
    FOR campaign_record IN 
        SELECT c.*, 
               CASE 
                   WHEN c.campaign_type = 'flash_sale' THEN 0.8
                   WHEN c.campaign_type = 'seasonal' THEN 0.6
                   WHEN c.campaign_type = 'membership' THEN 0.4
                   ELSE 0.5
               END as base_weight
        FROM campaigns c
        WHERE order_date BETWEEN c.start_date AND c.end_date
    LOOP
        -- è¨ˆç®—æ­¸å› æ¬Šé‡
        active_campaigns := active_campaigns || jsonb_build_object(
            'campaign_id', campaign_record.id,
            'campaign_name', campaign_record.campaign_name,
            'campaign_type', campaign_record.campaign_type,
            'layer', CASE 
                WHEN campaign_record.campaign_type IN ('seasonal', 'holiday', 'anniversary') THEN 'site-wide'
                WHEN campaign_record.campaign_type IN ('membership', 'demographic') THEN 'target-oriented'  
                WHEN campaign_record.campaign_type IN ('category', 'product_launch') THEN 'category-specific'
                ELSE 'general'
            END,
            'weight', campaign_record.base_weight,
            'attribution_reason', 'æ´»å‹•æœŸé–“é‡ç–Š'
        );
    END LOOP;
    
    RETURN active_campaigns;
END;
$$ LANGUAGE plpgsql;
```

### **ç­–ç•¥ä¸‰ï¼šæ­¸å› è¦–åœ–é‡æ§‹**

```sql
-- æ–°çš„ç‡Ÿæ”¶æ­¸å› è¦–åœ–
CREATE OR REPLACE VIEW revenue_attribution_analysis AS
WITH order_campaigns AS (
    SELECT 
        o.id as order_id,
        o.user_id,
        o.total_amount,
        o.created_at::date as order_date,
        calculate_attribution_weights(
            o.created_at::date, 
            o.total_amount, 
            o.user_id
        ) as campaign_attributions
    FROM orders o 
    WHERE o.status IN ('paid', 'processing', 'shipped', 'delivered', 'completed')
),
expanded_attributions AS (
    SELECT 
        oc.order_id,
        oc.order_date,
        oc.total_amount,
        (attribution->>'campaign_id')::UUID as campaign_id,
        attribution->>'campaign_name' as campaign_name,
        attribution->>'campaign_type' as campaign_type,
        attribution->>'layer' as attribution_layer,
        (attribution->>'weight')::NUMERIC as attribution_weight,
        -- è¨ˆç®—åˆ†é…çš„ç‡Ÿæ”¶
        oc.total_amount * (attribution->>'weight')::NUMERIC as attributed_revenue
    FROM order_campaigns oc,
    LATERAL jsonb_array_elements(oc.campaign_attributions) as attribution
)
SELECT 
    campaign_id,
    campaign_name,
    campaign_type,
    attribution_layer,
    COUNT(DISTINCT order_id) as influenced_orders,
    SUM(attributed_revenue) as total_attributed_revenue,
    AVG(attributed_revenue) as avg_attributed_revenue,
    SUM(attribution_weight) as total_attribution_weight,
    AVG(attribution_weight) as avg_attribution_strength
FROM expanded_attributions
GROUP BY campaign_id, campaign_name, campaign_type, attribution_layer
ORDER BY total_attributed_revenue DESC;
```

## å¤šè§’åº¦åˆ†æè¦–åœ–

### **1. æ´»å‹•é‡ç–Šåˆ†æ**

```sql
CREATE VIEW campaign_overlap_analysis AS
WITH daily_campaigns AS (
    SELECT 
        generate_series(start_date, end_date, '1 day'::interval)::date as date,
        id as campaign_id,
        campaign_name,
        campaign_type
    FROM campaigns
),
overlap_summary AS (
    SELECT 
        date,
        COUNT(*) as concurrent_campaigns,
        STRING_AGG(campaign_name, ' + ' ORDER BY campaign_type) as campaign_combination,
        ARRAY_AGG(campaign_type ORDER BY campaign_type) as campaign_types
    FROM daily_campaigns
    GROUP BY date
)
SELECT 
    date,
    concurrent_campaigns,
    campaign_combination,
    campaign_types,
    CASE 
        WHEN concurrent_campaigns = 1 THEN 'single'
        WHEN concurrent_campaigns = 2 THEN 'dual_overlap'
        WHEN concurrent_campaigns >= 3 THEN 'multi_overlap'
    END as overlap_type
FROM overlap_summary
ORDER BY date;
```

### **2. æ­¸å› æ•ˆæœæ¯”è¼ƒ**

```sql
CREATE VIEW attribution_effectiveness_comparison AS
WITH traditional_attribution AS (
    -- å‚³çµ±å–®ä¸€æ­¸å› æ–¹æ³•çš„çµæœ
    SELECT 
        c.id as campaign_id,
        c.campaign_name,
        COUNT(DISTINCT o.id) as traditional_orders,
        SUM(o.total_amount) as traditional_revenue
    FROM campaigns c
    LEFT JOIN orders o ON o.created_at::date BETWEEN c.start_date AND c.end_date
        AND o.status IN ('paid', 'processing', 'shipped', 'delivered', 'completed')
    GROUP BY c.id, c.campaign_name
),
layered_attribution AS (
    -- åˆ†å±¤æ­¸å› æ–¹æ³•çš„çµæœ
    SELECT 
        campaign_id,
        campaign_name,
        influenced_orders as layered_orders,
        total_attributed_revenue as layered_revenue
    FROM revenue_attribution_analysis
)
SELECT 
    COALESCE(ta.campaign_id, la.campaign_id) as campaign_id,
    COALESCE(ta.campaign_name, la.campaign_name) as campaign_name,
    COALESCE(ta.traditional_orders, 0) as traditional_orders,
    COALESCE(ta.traditional_revenue, 0) as traditional_revenue,
    COALESCE(la.layered_orders, 0) as layered_orders,
    COALESCE(la.layered_revenue, 0) as layered_revenue,
    -- è¨ˆç®—å·®ç•°
    (COALESCE(la.layered_revenue, 0) - COALESCE(ta.traditional_revenue, 0)) as revenue_difference,
    CASE 
        WHEN ta.traditional_revenue > 0 
        THEN ROUND(100.0 * (la.layered_revenue - ta.traditional_revenue) / ta.traditional_revenue, 2)
        ELSE NULL 
    END as revenue_difference_pct
FROM traditional_attribution ta
FULL OUTER JOIN layered_attribution la USING (campaign_id)
ORDER BY ABS(COALESCE(revenue_difference, 0)) DESC;
```

## ğŸ® å¯¦éš›æ‡‰ç”¨å ´æ™¯

### **å ´æ™¯ä¸€ï¼šæ˜¥å­£æ´»å‹•çµ„åˆåˆ†æ**

```sql
-- åˆ†æ 2025å¹´3æœˆçš„æ´»å‹•çµ„åˆæ•ˆæœ
SELECT 
    oa.date,
    oa.campaign_combination,
    oa.concurrent_campaigns,
    SUM(o.total_amount) as daily_revenue,
    COUNT(DISTINCT o.id) as daily_orders
FROM campaign_overlap_analysis oa
LEFT JOIN orders o ON o.created_at::date = oa.date
WHERE oa.date BETWEEN '2025-03-01' AND '2025-03-31'
GROUP BY oa.date, oa.campaign_combination, oa.concurrent_campaigns
ORDER BY daily_revenue DESC;
```

### **å ´æ™¯äºŒï¼šæ´»å‹•è²¢ç»åº¦åˆ†æ**

```sql
-- åˆ†ææ¯å€‹æ´»å‹•åœ¨é‡ç–ŠæœŸé–“çš„å¯¦éš›è²¢ç»
SELECT 
    campaign_name,
    attribution_layer,
    total_attributed_revenue,
    avg_attribution_strength,
    -- è¨ˆç®—åœ¨é‡ç–ŠæœŸé–“çš„è²¢ç»æ¯”ä¾‹
    ROUND(
        100.0 * total_attributed_revenue / 
        SUM(total_attributed_revenue) OVER (PARTITION BY attribution_layer), 
        2
    ) as layer_contribution_pct
FROM revenue_attribution_analysis
WHERE attribution_layer IS NOT NULL
ORDER BY attribution_layer, total_attributed_revenue DESC;
```

## ç­–ç•¥å„ªå‹¢

### **1. æ¶ˆé™¤é‡è¤‡è¨ˆç®—**
- æ¯ç­†ç‡Ÿæ”¶åªè¨ˆç®—ä¸€æ¬¡ï¼Œä½†å¯æ­¸å› çµ¦å¤šå€‹æ´»å‹•
- ä½¿ç”¨æ¬Šé‡åˆ†é…é¿å…ç¸½é¡ä¸åŒ¹é…

### **2. ä¿ç•™æ¥­å‹™æ´å¯Ÿ**
- æ¸…æ¥šé¡¯ç¤ºæ´»å‹•é–“çš„å”åŒæ•ˆæ‡‰
- é‡åŒ–ä¸åŒé¡å‹æ´»å‹•çš„å½±éŸ¿ç¨‹åº¦

### **3. æ”¯æ´æ±ºç­–åˆ¶å®š**
- å¹«åŠ©è­˜åˆ¥æœ€ä½³æ´»å‹•çµ„åˆ
- å„ªåŒ–æ´»å‹•æ’ç¨‹å’Œé ç®—åˆ†é…

### **4. éˆæ´»æ“´å±•**
- å¯è¼•é¬†åŠ å…¥æ–°çš„æ­¸å› ç¶­åº¦
- æ”¯æ´ä¸åŒçš„æ¥­å‹™æ­¸å› é‚è¼¯

## ğŸ“ˆ å¯¦æ–½å»ºè­°

### **éšæ®µä¸€ï¼šåŸºç¤æ¶æ§‹**
1. å»ºç«‹æ­¸å› äº‹å¯¦è¡¨
2. å¯¦ä½œæ¬Šé‡è¨ˆç®—æ¼”ç®—æ³•
3. é‡æ§‹ç¾æœ‰åˆ†æè¦–åœ–

### **éšæ®µäºŒï¼šé€²éšåŠŸèƒ½**  
1. åŠ å…¥ç”¨æˆ¶è¡Œç‚ºè¿½è¹¤
2. å¯¦ä½œæ©Ÿå™¨å­¸ç¿’æ­¸å› æ¨¡å‹
3. å»ºç«‹å³æ™‚æ­¸å› åˆ†æ

### **éšæ®µä¸‰ï¼šæ¥­å‹™æ•´åˆ**
1. æ•´åˆè¡ŒéŠ·æ­¸å› å¹³å°
2. å»ºç«‹è‡ªå‹•åŒ–å ±å‘Š
3. è¨“ç·´æ¥­å‹™åœ˜éšŠä½¿ç”¨

é€™ç¨®åˆ†å±¤æ­¸å› ç­–ç•¥èƒ½å¤ çœŸå¯¦åæ˜ è¤‡é›œå•†æ¥­ç’°å¢ƒä¸­çš„æ´»å‹•æ•ˆæœï¼ŒåŒæ™‚ä¿æŒè³‡æ–™åˆ†æçš„æº–ç¢ºæ€§å’Œå¯¦ç”¨æ€§ã€‚