
═══════════════════════════════════════════════════════
🔍 Supabase RLS 政策稽核報告
═══════════════════════════════════════════════════════


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚨 檢查 1: 未啟用 RLS 的資料表
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

 Schema | 資料表名稱 | 表類型 | RLS已啟用 
--------+------------+--------+-----------
(0 rows)


預期結果: 僅有 Views 和系統表應該未啟用 RLS


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚨 檢查 2: 已啟用 RLS 但無政策的資料表
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

 Schema | 資料表名稱 | RLS已啟用 | 政策數量 
--------+------------+-----------+----------
(0 rows)


預期結果: 無資料表（所有啟用 RLS 的表都應有政策）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 檢查 3: 允許匿名（anon）存取的政策
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

 Schema | 資料表名稱 | 政策名稱 | 操作類型 | 適用角色 
--------+------------+----------+----------+----------
(0 rows)


預期結果: 無政策（後台管理系統不應允許匿名存取）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 檢查 4: 無條件允許的政策 (USING true)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

 Schema |           資料表名稱            |                     政策名稱                      | 操作類型 |   存取控制   | USING 條件 
--------+---------------------------------+---------------------------------------------------+----------+--------------+------------
 public | agent_assignments               | agent_assignments_select_all                      | SELECT   | ⚠️ 無條件允許 | true
 public | ai_system_audit_log             | ai_system_audit_log_select_all                    | SELECT   | ⚠️ 無條件允許 | true
 public | alert_content_templates         | Allow authenticated users to read alert templates | SELECT   | ⚠️ 無條件允許 | true
 public | conversation_assignment_history | conversation_assignment_history_select_all        | SELECT   | ⚠️ 無條件允許 | true
 public | dashboard_alerts                | 警示可查看                                        | SELECT   | ⚠️ 無條件允許 | true
 public | default_avatars                 | default_avatars_select_all                        | SELECT   | ⚠️ 無條件允許 | true
 public | dim_date                        | dim_date_select_all                               | SELECT   | ⚠️ 無條件允許 | true
 public | events                          | events_select_all                                 | SELECT   | ⚠️ 無條件允許 | true
 public | funnel_events                   | funnel_events_select_all                          | SELECT   | ⚠️ 無條件允許 | true
 public | holidays                        | holidays_select_all                               | SELECT   | ⚠️ 無條件允許 | true
 public | metric_thresholds               | 閾值配置可查看                                    | SELECT   | ⚠️ 無條件允許 | true
 public | order_items_jsonb_audit         | order_items_jsonb_audit_select_all                | SELECT   | ⚠️ 無條件允許 | true
 public | orders_jsonb_audit              | orders_jsonb_audit_select_all                     | SELECT   | ⚠️ 無條件允許 | true
 public | payments                        | payments_select_all                               | SELECT   | ⚠️ 無條件允許 | true
 public | role_audit_log                  | role_audit_log_select_all                         | SELECT   | ⚠️ 無條件允許 | true
 public | sku_attribute_codes             | sku_attribute_codes_select_all                    | SELECT   | ⚠️ 無條件允許 | true
 public | sku_generation_rules            | sku_generation_rules_select_all                   | SELECT   | ⚠️ 無條件允許 | true
 public | system_settings                 | system_settings_select_all                        | SELECT   | ⚠️ 無條件允許 | true
 public | user_sessions                   | user_sessions_select_all                          | SELECT   | ⚠️ 無條件允許 | true
(19 rows)


說明: 檢查哪些表允許所有 authenticated 用戶無條件讀取
      Reference Data 和 Audit Logs 可以是 true（預期行為）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔐 檢查 5: 敏感資料表的 RLS 政策
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  敏感資料表   | RLS已啟用 | 政策數量 |   安全狀態   
---------------+-----------+----------+--------------
 payments      | t         |        1 | ⚠️ 政策不完整
 conversations | t         |        4 | ✅ 政策完整
 customers     | t         |        4 | ✅ 政策完整
 inventories   | t         |        4 | ✅ 政策完整
 messages      | t         |        4 | ✅ 政策完整
 notifications | t         |        4 | ✅ 政策完整
 order_items   | t         |        4 | ✅ 政策完整
 orders        | t         |        5 | ✅ 政策完整
 products      | t         |        4 | ✅ 政策完整
 users         | t         |        4 | ✅ 政策完整
(10 rows)


預期結果: 所有敏感表應該啟用 RLS 並有 4 個政策 (SELECT, INSERT, UPDATE, DELETE)


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔑 檢查 6: 權限系統整合驗證
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

         資料表名稱         | 政策數量 | 使用權限檢查 | 整合狀態 
----------------------------+----------+--------------+----------
 ai_models                  |        4 | t            | ✅ 已整合
 ai_provider_credentials    |        4 | t            | ✅ 已整合
 ai_providers               |        4 | t            | ✅ 已整合
 ai_usage_logs              |        2 | t            | ✅ 已整合
 campaign_type_config       |        4 | t            | ✅ 已整合
 campaigns                  |        4 | t            | ✅ 已整合
 categories                 |        4 | t            | ✅ 已整合
 conversations              |        4 | t            | ✅ 已整合
 customers                  |        4 | t            | ✅ 已整合
 inventories                |        4 | t            | ✅ 已整合
 inventory_logs             |        2 | t            | ✅ 已整合
 messages                   |        4 | t            | ✅ 已整合
 notification_distributions |        4 | t            | ✅ 已整合
 notification_groups        |        4 | t            | ✅ 已整合
 notification_logs          |        2 | t            | ✅ 已整合
 notification_preferences   |        4 | t            | ✅ 已整合
 notification_recipients    |        4 | t            | ✅ 已整合
 notification_routing_rules |        4 | t            | ✅ 已整合
 notification_templates     |        4 | t            | ✅ 已整合
 notifications              |        4 | t            | ✅ 已整合
 order_items                |        4 | t            | ✅ 已整合
 orders                     |        5 | t            | ✅ 已整合
 permission_groups          |        4 | t            | ✅ 已整合
 permissions                |        4 | t            | ✅ 已整合
 products                   |        4 | t            | ✅ 已整合
 role_permissions           |        3 | t            | ✅ 已整合
 roles                      |        4 | t            | ✅ 已整合
 tickets                    |        4 | t            | ✅ 已整合
 user_roles                 |        3 | t            | ✅ 已整合
 users                      |        4 | t            | ✅ 已整合
 ai_prompt_provider_configs |        2 | f            | ⚠️ 未整合
 ai_prompt_templates        |        2 | f            | ⚠️ 未整合
 ai_system_config           |        1 | f            | ⚠️ 未整合
 alert_content_templates    |        2 | f            | ⚠️ 未整合
 dashboard_alerts           |        2 | f            | ⚠️ 未整合
 dim_date                   |        1 | f            | ⚠️ 未整合
 events                     |        1 | f            | ⚠️ 未整合
 funnel_events              |        1 | f            | ⚠️ 未整合
 metric_thresholds          |        2 | f            | ⚠️ 未整合
 payments                   |        1 | f            | ⚠️ 未整合
 system_settings            |        1 | f            | ⚠️ 未整合
(41 rows)


說明: 業務表應該使用 has_permission() 函數進行權限控制
      Reference/Audit/System 表可以使用簡單的 authenticated 檢查


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🛡️ 檢查 7: Super Admin 保護機制
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

           政策名稱            | 操作類型 | Super Admin 保護 |                                                                                 USING 條件                                                                                  
-------------------------------+----------+------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 users_delete_with_protections | DELETE   | ✅ 有保護         | ((email <> 'system@internal.system'::text) AND has_permission(auth.uid(), 'role.user.manage'::text) AND (NOT is_target_super_admin(id)) AND (id <> ( SELECT users_1.id     +
                               |          |                  |    FROM users users_1                                                                                                                                                      +
                               |          |                  |   WHERE (users_1.auth_user_id = auth.uid()))))
 users_update_with_protections | UPDATE   | ✅ 有保護         | ((email <> 'system@internal.system'::text) AND ((auth_user_id = auth.uid()) OR (has_permission(auth.uid(), 'role.user.manage'::text) AND (NOT is_target_super_admin(id)))))
(2 rows)


預期結果: users 表的 UPDATE 和 DELETE 政策應該包含 Super Admin 保護


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🛡️ 檢查 8: 系統用戶（system@internal.system）保護機制
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

               政策名稱               | 操作類型 | 系統用戶保護 |                                   USING 條件摘要                                    
--------------------------------------+----------+--------------+-------------------------------------------------------------------------------------
 users_delete_with_protections        | DELETE   | ✅ 有保護     | ((email <> 'system@internal.system'::text) AND has_permission(auth.uid(), 'role....
 users_insert_self                    | INSERT   | ❌ 無保護     | 
 users_select_self_or_with_permission | SELECT   | ✅ 有保護     | ((email <> 'system@internal.system'::text) AND ((auth_user_id = auth.uid()) OR h...
 users_update_with_protections        | UPDATE   | ✅ 有保護     | ((email <> 'system@internal.system'::text) AND ((auth_user_id = auth.uid()) OR (...
(4 rows)


預期結果: users 表的所有操作都應該排除 system@internal.system


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 檢查 9: RLS 配置統計摘要
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

 總資料表數 | 已啟用 RLS | 未啟用 RLS | 有政策的表 | 總政策數 | RLS 覆蓋率 
------------+------------+------------+------------+----------+------------
         52 |         52 |          0 |         52 |      140 | 100.00%
(1 row)


═══════════════════════════════════════════════════════
✅ 稽核報告完成
═══════════════════════════════════════════════════════

