# å®Œæ•´è³‡æ–™åº«é‡ç½®æŒ‡å—

## æ¦‚è¿°

æ­¤æŒ‡å—å”åŠ©ä½ å®‰å…¨åœ°é‡ç½® Supabase è³‡æ–™åº«ï¼ŒåŒ…å«å®Œæ•´çš„ Super Admin è‡ªå‹•é‡å»ºæ©Ÿåˆ¶å’Œæ‰€æœ‰å¿…è¦çš„åˆå§‹è³‡æ–™ã€‚

## ğŸ”„ DB Reset æµç¨‹èªªæ˜

### ç•¶åŸ·è¡Œ `supabase db reset` æ™‚æœƒç™¼ç”Ÿä»€éº¼ï¼š

1. **æ¸…é™¤æ‰€æœ‰è³‡æ–™**: åˆªé™¤ç¾æœ‰çš„æ‰€æœ‰è¡¨å’Œè³‡æ–™
2. **åŸ·è¡Œ Migrations**: æŒ‰é †åºåŸ·è¡Œ `migrations/` è³‡æ–™å¤¾ä¸­çš„æ‰€æœ‰ SQL æª”æ¡ˆ
3. **åŸ·è¡Œ Seed è³‡æ–™**: è‡ªå‹•åŸ·è¡Œ `seed.sql` æª”æ¡ˆ

### åŸ·è¡Œé †åº

```
1. æ¸…é™¤è³‡æ–™åº«
2. åŸ·è¡Œæ‰€æœ‰ migration æª”æ¡ˆ (æŒ‰æª”åé †åº)
3. åŸ·è¡Œ seed.sql (è‡ªå‹•åˆå§‹åŒ–)
```

---

## ğŸ”‘ Super Admin è‡ªå‹•é‡å»ºæ©Ÿåˆ¶

### âœ… å·²å¯¦ç¾åŠŸèƒ½

åœ¨æ¯æ¬¡ DB reset å¾Œï¼Œ`seed.sql` æœƒè‡ªå‹•ï¼š

1. **åŸ·è¡Œç³»çµ±åˆå§‹åŒ–**: å‘¼å« `initialize_super_admin_system()`
2. **å»ºç«‹ Super Admin è§’è‰²**: ç¢ºä¿ `super_admin` è§’è‰²å­˜åœ¨ä¸”å—ä¿è­·
3. **å»ºç«‹èªè­‰å¸³æˆ¶**: åœ¨ `auth.users` ä¸­å»ºç«‹å®Œæ•´èªè­‰
4. **å»ºç«‹ç”¨æˆ¶è¨˜éŒ„**: åœ¨ `users` è¡¨ä¸­å»ºç«‹ä¸¦é€£çµ
5. **åˆ†é…è§’è‰²**: è‡ªå‹•åˆ†é… Super Admin è§’è‰²
6. **åˆ†é…æ¬Šé™**: ç‚ºæ‰€æœ‰è§’è‰²åˆ†é…é©ç•¶æ¬Šé™

### ğŸ”‘ é è¨­ Super Admin ç™»å…¥è³‡è¨Š

**æ¯æ¬¡ DB reset å¾Œéƒ½æœƒé‡å»º**ï¼š

- **Email**: `admin@system.local`
- **å¯†ç¢¼**: `SuperAdmin`

âš ï¸ **é‡è¦**: é€™æ˜¯å›ºå®šçš„é è¨­å¯†ç¢¼ï¼Œä»»ä½•äººéƒ½èƒ½çœ‹åˆ°æ­¤æ–‡æª”ï¼Œæ‰€ä»¥ï¼š

- DB reset å¾Œè«‹**ç«‹å³**ç™»å…¥ä¸¦æ›´æ”¹å¯†ç¢¼
- ç”Ÿç”¢ç’°å¢ƒæ‡‰ä¿®æ”¹æˆ–ç§»é™¤æ­¤æ©Ÿåˆ¶

---

## åŸ·è¡Œ DB Reset

### å®Œæ•´é‡å»º

```bash
# åœ¨ supabase ç›®éŒ„ä¸‹åŸ·è¡Œ
supabase db reset

# æ‚¨æœƒçœ‹åˆ° Super Admin åˆå§‹åŒ–è¨Šæ¯ï¼š
# ================================================
# âœ… Super Admin ç³»çµ±å·²è‡ªå‹•åˆå§‹åŒ–
# ================================================
#
# ğŸ”‘ Super Admin ç™»å…¥è³‡è¨Šï¼š
# - Email: admin@system.local
# - å¯†ç¢¼: SuperAdmin
```

### åƒ…åŸ·è¡Œ Migrations

```bash
# å¦‚æœåªæƒ³åŸ·è¡Œ migrations è€Œä¸åŸ·è¡Œ seed.sql
supabase db reset --linked
```

---

## ğŸ“ é‡è¦æª”æ¡ˆèªªæ˜

### 1. `export_initial_data.sql`

**ç”¨é€”**ï¼šåŒ¯å‡ºç•¶å‰è³‡æ–™åº«ä¸­çš„åˆå§‹è³‡æ–™  
**åŸ·è¡Œæ™‚æ©Ÿ**ï¼šé‡ç½®å‰åŸ·è¡Œï¼Œç”¨æ–¼å‚™ä»½ç¾æœ‰è³‡æ–™

**ä½¿ç”¨æ–¹å¼**ï¼š

1. æ‰“é–‹ http://localhost:54323 (Supabase Studio)
2. é€²å…¥ SQL Editor
3. è¤‡è£½ä¸¦åŸ·è¡Œ `export_initial_data.sql` ä¸­çš„æŸ¥è©¢
4. å°‡çµæœè¤‡è£½ä¿å­˜åˆ°æ–‡å­—æª”

### 2. `seed.sql`

**ç”¨é€”**ï¼šåŒ…å«æ‰€æœ‰å¿…è¦åˆå§‹è³‡æ–™çš„ç¨®å­æª”æ¡ˆ  
**å…§å®¹åŒ…æ‹¬**ï¼š

- âœ… System settings (ç³»çµ±è¨­å®š)
- âœ… System user (ç³»çµ±ç”¨æˆ¶: `00000000-0000-0000-0000-000000000000`)
- âœ… RFM segment mapping (RFM åˆ†ç¾¤å°æ‡‰)
- âœ… Super Admin è‡ªå‹•åˆå§‹åŒ–
- âœ… è§’è‰²æ¬Šé™å®Œæ•´é…ç½®
- âœ… å•†å“åˆ†é¡è³‡æ–™
- âœ… è¡ŒéŠ·æ´»å‹•è³‡æ–™

### 3. `verify_seed_data.sql`

**ç”¨é€”**ï¼šé©—è­‰è³‡æ–™åº«é‡ç½®å¾Œçš„è³‡æ–™å®Œæ•´æ€§  
**åŸ·è¡Œæ™‚æ©Ÿ**ï¼šé‡ç½®å¾ŒåŸ·è¡Œï¼Œç¢ºèªè³‡æ–™æ­£ç¢ºè¼‰å…¥

---

## å®‰å…¨æ³¨æ„äº‹é …

### DB Reset å¾Œå¿…é ˆåŸ·è¡Œ

1. **ç«‹å³æ›´æ”¹å¯†ç¢¼**: ä½¿ç”¨é è¨­å¯†ç¢¼ç™»å…¥å¾Œç«‹å³æ›´æ”¹
2. **æª¢æŸ¥ç³»çµ±ç‹€æ…‹**: ç¢ºèªæ‰€æœ‰ä¿è­·æ©Ÿåˆ¶æ­£å¸¸
3. **å•Ÿç”¨ 2FA**: ç‚º Super Admin å¸³æˆ¶å•Ÿç”¨é›™å› ç´ èªè­‰

### æª¢æŸ¥ç³»çµ±å¥åº·

```sql
-- æª¢æŸ¥ Super Admin ç³»çµ±ç‹€æ…‹
SELECT * FROM check_super_admin_system_health();

-- æŸ¥çœ‹æ‰€æœ‰ç³»çµ±è§’è‰²
SELECT * FROM get_system_roles_status();

-- ç·Šæ€¥å¯†ç¢¼é‡è¨­
SELECT reset_super_admin_password('YourNewSecurePassword2025#');
```

---

## é‡ç½®å‰æº–å‚™å·¥ä½œ

### é‡è¦ï¼šé‡ç½®å‰çš„è³‡æ–™å‚™ä»½

**åœ¨é‡ç½®å‰ï¼Œå»ºè­°å…ˆåŒ¯å‡ºç•¶å‰çš„é—œéµè³‡æ–™ï¼š**

1. **ä½¿ç”¨ Supabase Studio**ï¼šæ‰“é–‹ http://localhost:54323ï¼Œåœ¨ SQL Editor ä¸­åŸ·è¡Œ `export_initial_data.sql` æŸ¥è©¢
2. **æª¢æŸ¥é—œéµè³‡æ–™**ï¼š

```sql
-- æª¢æŸ¥ç³»çµ±è¨­å®š
SELECT * FROM system_settings;

-- æª¢æŸ¥ç³»çµ±ç”¨æˆ¶
SELECT * FROM users WHERE id = '00000000-0000-0000-0000-000000000000';

-- æª¢æŸ¥è§’è‰²
SELECT * FROM roles;

-- æª¢æŸ¥æ¬Šé™
SELECT * FROM permissions LIMIT 10;
```

---

## âœ… é©—è­‰æª¢æŸ¥é»

é‡ç½®å¾Œè«‹ç¢ºèªä»¥ä¸‹é …ç›®ï¼š

### ç³»çµ±è¨­å®š

- [ ] `fast_response_threshold_minutes = 15`
- [ ] `medium_response_threshold_minutes = 30`
- [ ] `slow_response_threshold_minutes = 60`
- [ ] `agent_busy_threshold = 5`

### ğŸ‘¤ ç³»çµ±ç”¨æˆ¶

- [ ] ç³»çµ±ç”¨æˆ¶ ID: `00000000-0000-0000-0000-000000000000` å­˜åœ¨
- [ ] Email: `system@internal.system`

### ğŸ”‘ Super Admin ç³»çµ±

- [ ] Super Admin è§’è‰²å­˜åœ¨ä¸”å—ä¿è­·
- [ ] Super Admin èªè­‰å¸³æˆ¶å¯æ­£å¸¸ç™»å…¥
- [ ] æ“æœ‰æ‰€æœ‰ç³»çµ±æ¬Šé™
- [ ] ç¨½æ ¸æ—¥èªŒæ­£å¸¸è¨˜éŒ„

### è§’è‰²èˆ‡æ¬Šé™

- [ ] è§’è‰²è¡¨ (roles) è³‡æ–™æ­£ç¢ºè¼‰å…¥
- [ ] æ¬Šé™è¡¨ (permissions) è³‡æ–™æ­£ç¢ºè¼‰å…¥
- [ ] æ¬Šé™ç¾¤çµ„ (permission_groups) è³‡æ–™æ­£ç¢ºè¼‰å…¥
- [ ] è§’è‰²æ¬Šé™é—œè¯ (role_permissions) æ­£ç¢ºè¨­å®š

### RFM åˆ†ç¾¤

- [ ] è‡³å°‘ 50 å€‹ RFM æ¨¡å¼
- [ ] 6 å€‹åˆ†ç¾¤é¡å‹ï¼šVIP, Loyal, Potential, New, At Risk, Lost

---

## ğŸ“ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

#### 1. Super Admin ç™»å…¥å¤±æ•—

```sql
-- æª¢æŸ¥èªè­‰å¸³æˆ¶æ˜¯å¦å­˜åœ¨
SELECT id, email, email_confirmed_at
FROM auth.users
WHERE email = 'admin@system.local';

-- å¦‚æœä¸å­˜åœ¨ï¼Œå¼·åˆ¶é‡å»º
SELECT ensure_super_admin_user_with_auth(true);
```

#### 2. æ¬Šé™ä¸è¶³

```sql
-- æª¢æŸ¥è§’è‰²åˆ†é…
SELECT u.email, r.name as role_name
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
WHERE u.email = 'admin@system.local';

-- æª¢æŸ¥æ¬Šé™åˆ†é…
SELECT COUNT(*) as permission_count
FROM role_permissions rp
JOIN roles r ON rp.role_id = r.id
WHERE r.name = 'super_admin';
```

#### 3. ç³»çµ±ç‹€æ…‹ç•°å¸¸

```sql
-- å®Œæ•´ç³»çµ±å¥åº·æª¢æŸ¥
SELECT * FROM check_super_admin_system_health();

-- å¦‚æœæœ‰å•é¡Œï¼Œé‡æ–°åˆå§‹åŒ–
SELECT initialize_super_admin_system();
```

### ç·Šæ€¥æ¢å¾©

```sql
-- å®Œå…¨é‡å»º Super Admin ç³»çµ±
SELECT ensure_super_admin_user_with_auth(true);

-- é‡è¨­ç‚ºæ–°å¯†ç¢¼
SELECT reset_super_admin_password('EmergencyPassword2025!');

-- æª¢æŸ¥æ¢å¾©çµæœ
SELECT * FROM check_super_admin_system_health();
```

---

## ä¸åŒç’°å¢ƒçš„å»ºè­°

### é–‹ç™¼ç’°å¢ƒ

- âœ… ä¿æŒç¾æœ‰çš„è‡ªå‹•åˆå§‹åŒ–æ©Ÿåˆ¶
- âœ… ä½¿ç”¨é è¨­å¯†ç¢¼æ–¹ä¾¿æ¸¬è©¦
- âœ… æ¯æ¬¡ reset å¾Œè‡ªå‹•é‡å»º

### æ¸¬è©¦ç’°å¢ƒ

- âš ï¸ è€ƒæ…®ä½¿ç”¨éš¨æ©Ÿå¯†ç¢¼
- âš ï¸ å»ºç«‹è‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬
- âš ï¸ å®šæœŸæª¢æŸ¥å®‰å…¨é…ç½®

### ç”Ÿç”¢ç’°å¢ƒ

- âŒ **ç§»é™¤é è¨­å¯†ç¢¼æ©Ÿåˆ¶**
- âŒ **æ‰‹å‹•å»ºç«‹ Super Admin**
- âŒ **ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ç®¡ç†å¯†ç¢¼**
- âŒ **å•Ÿç”¨æ‰€æœ‰å®‰å…¨æ©Ÿåˆ¶**

### ç”Ÿç”¢ç’°å¢ƒä¿®æ”¹å»ºè­°

```sql
-- åœ¨ç”Ÿç”¢ç’°å¢ƒçš„ seed.sql ä¸­ï¼Œä¿®æ”¹ç‚ºï¼š
-- SELECT initialize_super_admin_system(); -- è¨»è§£æ‰è‡ªå‹•åˆå§‹åŒ–

-- æ”¹ç‚ºæ‰‹å‹•æŒ‡ä»¤ï¼š
-- 1. æ‰‹å‹•åŸ·è¡Œåˆå§‹åŒ–
-- 2. ç«‹å³æ›´æ”¹å¯†ç¢¼
-- 3. å•Ÿç”¨ 2FA
-- 4. é™åˆ¶è¨ªå•æ¬Šé™
```

---

## âœ… æª¢æŸ¥æ¸…å–®

### DB Reset å¾Œå¿…åšäº‹é …

- [ ] ç¢ºèª Super Admin åˆå§‹åŒ–è¨Šæ¯å‡ºç¾
- [ ] ä½¿ç”¨é è¨­å¯†ç¢¼ç™»å…¥æˆåŠŸ
- [ ] ç«‹å³æ›´æ”¹ç‚ºå¼·å¯†ç¢¼
- [ ] æª¢æŸ¥ç³»çµ±å¥åº·ç‹€æ³
- [ ] å•Ÿç”¨é›™å› ç´ èªè­‰ (å»ºè­°)
- [ ] æª¢æŸ¥æ‰€æœ‰è§’è‰²æ¬Šé™æ­£ç¢º
- [ ] é©—è­‰æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸

### å®šæœŸç¶­è­·

- [ ] æ¯æœˆæª¢æŸ¥ç³»çµ±å¥åº·ç‹€æ³
- [ ] å®šæœŸæ›´æ–° Super Admin å¯†ç¢¼
- [ ] æª¢æŸ¥ç¨½æ ¸æ—¥èªŒç•°å¸¸
- [ ] ç¢ºèªä¿è­·æ©Ÿåˆ¶é‹ä½œæ­£å¸¸

---

## å®‰å…¨æé†’

- âš ï¸ é‡ç½®æœƒåˆªé™¤æ‰€æœ‰ç¾æœ‰è³‡æ–™
- âš ï¸ è«‹ç¢ºä¿åœ¨é–‹ç™¼ç’°å¢ƒä¸­é€²è¡Œæ¸¬è©¦
- âš ï¸ ç”Ÿç”¢ç’°å¢ƒé‡ç½®å‰å‹™å¿…å®Œæ•´å‚™ä»½
- âš ï¸ ç¢ºèªæ‰€æœ‰åœ˜éšŠæˆå“¡äº†è§£é‡ç½®å½±éŸ¿
- âš ï¸ é è¨­å¯†ç¢¼å¿…é ˆåœ¨é¦–æ¬¡ç™»å…¥å¾Œç«‹å³æ›´æ”¹

---

**ğŸ‰ ç¾åœ¨æ‚¨å¯ä»¥å®‰å¿ƒé€²è¡Œ DB resetï¼ŒSuper Admin å¸³æˆ¶æœƒè‡ªå‹•é‡å»ºï¼**

_æ›´æ–°æ—¥æœŸ: 2025-07-14_  
_æ–‡æª”ç‰ˆæœ¬: 2.0_
